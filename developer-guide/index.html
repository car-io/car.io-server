<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>EnviroCar Service by enviroCar</title>

        <link rel="stylesheet" href="http://envirocar.github.io/enviroCar-server/stylesheets/styles.css">
        <link rel="stylesheet" href="http://envirocar.github.io/enviroCar-server/stylesheets/pygment_trac.css">
        <script src="http://envirocar.github.io/enviroCar-server/javascripts/scale.fix.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <!--[if lt IE 9]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="wrapper">
            <header>
                <h1 class="header">EnviroCar Service</h1>
                <p class="header">
                    <a href="http://envirocar.github.io/enviroCar-server/developer-guide/">Developer Guide</a>
                </p>
                <p class="header"><a href="http://envirocar.github.io/enviroCar-server/api/">API Reference</a></p>
                <p class="header"><a href="http://envirocar.github.io/enviroCar-server/lod/">Linked Open Data</a></p>
                <p class="header"><a href="http://envirocar.github.io/enviroCar-server/additional-encodings/">Additional encodings for tracks</a></p>
                <ul>
                    <li class="but download"><a class="buttons" href="https://github.com/enviroCar/enviroCar-server/zipball/master">Download ZIP</a></li>
                    <li class="but download"><a class="buttons" href="https://github.com/enviroCar/enviroCar-server/tarball/master">Download TAR</a></li>
                    <li class="but"><a class="buttons github" href="https://github.com/enviroCar/enviroCar-server">View On GitHub</a></li>
                </ul>
            </header>
            <section>
                <h1 id="toc_0">Developer Guide</h1>

<h2 id="toc_1">Build &amp; Installation</h2>

<ul>
<li>Install and run <a href="http://www.mongodb.org/" title="MongoDB">MongoDB</a> &gt;2.4.</li>
<li>Clone the <a href="https://github.com/enviroCar/enviroCar-server.git" title="GitHub Repository">repository</a> and switch to the directory.</li>
<li>Configure the connection in <code>mongo/src/main/resources/mongo.properties</code> (if needed).</li>
<li>Run <code>mvn clean install</code>.</li>
<li>Deploy the <code>war</code> file in <code>webapp/target</code> to an application server of your choice (e.g. <a href="http://tomcat.apache.org/" title="Apache Tomcat">Apache Tomcat</a>).</li>
</ul>

<h2 id="toc_2">Guice</h2>

<p>The service makes heavy use of <a href="https://code.google.com/p/google-guice/" title="Guice">Guice</a>. Implementations are bound in a <code>Module</code>. For a detailed documentation see the <a href="https://code.google.com/p/google-guice/wiki/GettingStarted" title="Guice Documentation">Guice Wiki</a>. The service loads available module using the Java <a href="http://docs.oracle.com/javase/6/docs/api/java/util/ServiceLoader.html" title="ServiceLoader API">ServiceLoader API</a>.</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CoreModule</span> <span class="kd">extends</span> <span class="n">AbstractModule</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">DataService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">DataServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">UserServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">FriendService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">FriendServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">GroupService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">GroupServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">StatisticsService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">StatisticsServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">ActivityListener</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">asEagerSingleton</span><span class="o">();</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">PasswordEncoder</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">BCryptPasswordEncoder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">DateTimeZone</span><span class="o">.</span><span class="na">setDefault</span><span class="o">(</span><span class="n">DateTimeZone</span><span class="o">.</span><span class="na">UTC</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<h2 id="toc_3">Event Bus</h2>

<p>The service offers an extension API using a <a href="https://code.google.com/p/guava-libraries/wiki/EventBusExplained" title="EventBus">Guava EventBus</a>. The following events are accessible for extensions:</p>

<ul>
<li><code>ChangedGroupEvent</code>: fired after the description of a group was changed</li>
<li><code>ChangedMeasurementEvent</code>: fired after a measurements was changed</li>
<li><code>ChangedProfileEvent</code>: fired after the profile of a user was changed</li>
<li><code>ChangedTrackEvent</code>: fired after a track was changed</li>
<li><code>CreatedGroupEvent</code>: fired after a user created a new group</li>
<li><code>CreatedMeasurementEvent</code>: fired after a user created a new measurement</li>
<li><code>CreatedPhenomenonEvent</code>: fired after a user created a new phenomenon</li>
<li><code>CreatedSensorEvent</code>: fired after a user created a new sensor</li>
<li><code>CreatedTrackEvent</code>: fired after a user created a new track</li>
<li><code>CreatedUserEvent</code>: fired after a new user was created</li>
<li><code>DeletedGroupEvent</code>: fired after a user deleted a group</li>
<li><code>DeletedMeasurementEvent</code>: fired after a user deleted a measurement</li>
<li><code>DeletedTrackEvent</code>: fired after a user deleted a track</li>
<li><code>DeletedUserEvent</code>: fired after a user was deleted</li>
<li><code>FriendedUserEvent</code>: fired after a user friended another user</li>
<li><code>JoinedGroupEvent</code>: fired after a user joined a group</li>
<li><code>LeftGroupEvent</code>: fired after a user left a group</li>
<li><code>UnfriendedUserEvent</code>: fired after a user unfriended another user</li>
</ul>

<p>To subscribe to an event type you have to annotate some method with <code>@Subscribe</code>. The parameter type determines the type of event:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeListener</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DataService</span> <span class="n">service</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">SomeListener</span><span class="o">(</span><span class="n">DataService</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">service</span> <span class="o">=</span> <span class="n">service</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Subscribe</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreatedTrackEvent</span><span class="o">(</span><span class="n">CreatedTrackEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">doSomething</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getUser</span><span class="o">(),</span> <span class="n">service</span><span class="o">.</span><span class="na">getMeasurements</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">MeasurementFilter</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTrack</span><span class="o">())));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>A class that wants to receive events has to be created by Guice. For this you could declare it as a eager singleton in any module:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">bind</span><span class="o">(</span><span class="n">SomeListener</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">asEagerSingleton</span><span class="o">();</span>
</code></pre></div>
<h2 id="toc_4">RDF API</h2>

<p>Additional resources can be linked by implementing the interface <code>RDFLinker&lt;T&gt;</code> for the entity type <code>T</code>:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kn">import</span> <span class="nn">javax.ws.rs.core.UriBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.envirocar.server.rest.rights.AccessRights</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.inject.Provider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.hp.hpl.jena.rdf.model.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.hp.hpl.jena.rdf.model.Resource</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RDFLinker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">link</span><span class="o">(</span><span class="n">Model</span> <span class="n">m</span><span class="o">,</span> <span class="n">T</span> <span class="n">t</span><span class="o">,</span> <span class="n">AccessRights</span> <span class="n">rights</span><span class="o">,</span>
              <span class="n">Resource</span> <span class="n">r</span><span class="o">,</span> <span class="n">Provider</span><span class="o">&lt;</span><span class="n">UriBuilder</span><span class="o">&gt;</span> <span class="n">uriBuilder</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>The additional triples have to be added to the <code>Model m</code>. URIs to other entities can be build using the supplied <code>UriBuilder</code>. The rights of the current user to see properties and entities can be obtained using the <code>AccessRights</code> object. The following example adds latitude and longitude to a point measurement using the <a href="http://www.w3.org/2003/01/geo/" title="W3C Basic Geo">W3C Basic Geo vocabulary</a>:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kn">import</span> <span class="nn">javax.ws.rs.core.UriBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.envirocar.server.core.entities.Measurement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.envirocar.server.rest.encoding.rdf.RDFLinker</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.envirocar.server.rest.encoding.rdf.vocab.W3CGeo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.envirocar.server.rest.rights.AccessRights</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.inject.Provider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.hp.hpl.jena.rdf.model.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.hp.hpl.jena.rdf.model.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.geom.Point</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">W3CGeoMeasurementLinker</span> <span class="kd">implements</span> <span class="n">RDFLinker</span><span class="o">&lt;</span><span class="n">Measurement</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">link</span><span class="o">(</span><span class="n">Model</span> <span class="n">m</span><span class="o">,</span> <span class="n">Measurement</span> <span class="n">t</span><span class="o">,</span> <span class="n">AccessRights</span> <span class="n">rights</span><span class="o">,</span>
                     <span class="n">Resource</span> <span class="n">r</span><span class="o">,</span> <span class="n">Provider</span><span class="o">&lt;</span><span class="n">UriBuilder</span><span class="o">&gt;</span> <span class="n">uriBuilder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getGeometry</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">Point</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">m</span><span class="o">.</span><span class="na">setNsPrefix</span><span class="o">(</span><span class="n">W3CGeo</span><span class="o">.</span><span class="na">PREFIX</span><span class="o">,</span> <span class="n">W3CGeo</span><span class="o">.</span><span class="na">URI</span><span class="o">);</span>
            <span class="n">Point</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">Point</span><span class="o">)</span> <span class="n">t</span><span class="o">.</span><span class="na">getGeometry</span><span class="o">();</span>
            <span class="n">r</span><span class="o">.</span><span class="na">addLiteral</span><span class="o">(</span><span class="n">W3CGeo</span><span class="o">.</span><span class="na">lat</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">getY</span><span class="o">())</span>
             <span class="o">.</span><span class="na">addLiteral</span><span class="o">(</span><span class="n">W3CGeo</span><span class="o">.</span><span class="na">lon</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">getX</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>To let the service automatically faciliate the linker it has to be bound in any Guice module:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">Multibinder</span><span class="o">&lt;</span><span class="n">RDFLinker</span><span class="o">&lt;</span><span class="n">Measurement</span><span class="o">&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Multibinder</span><span class="o">.</span><span class="na">newSetBinder</span><span class="o">(</span>
        <span class="n">binder</span><span class="o">(),</span> <span class="k">new</span> <span class="n">TypeLiteral</span><span class="o">&lt;</span><span class="n">RDFLinker</span><span class="o">&lt;</span><span class="n">Measurement</span><span class="o">&gt;&gt;()</span> <span class="o">{});</span>
<span class="n">b</span><span class="o">.</span><span class="na">addBinding</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">W3CGeoMeasurementLinker</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div>
<h2 id="toc_4">Shapefile encoding of tracks</h2>

<p>Additional resources can be linked by implementing the interface <code>RDFLinker&lt;T&gt;</code> for the entity type <code>T</code>:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kn">import</span> <span class="nn">javax.ws.rs.core.UriBuilder</span><span class="o">;</span>
</code></pre></div>
            </section>
            <footer>
                <p><small>This project is maintained by the <a href="https://github.com/enviroCar">enviroCar</a> community</small></p>
            </footer>
        </div>
        <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    </body>
</html>
